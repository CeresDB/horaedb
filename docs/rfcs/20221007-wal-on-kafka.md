- Feature Name: (fill me in with a unique ident, my_awesome_feature)
- Tracking Issue: (open a issue to track this proposal and link it here)

# Summary
The distributed wal implementation based on kafka.

# Motivation
When using ceresdb of cluster mode, a distributed wal is needed. Although a distributed wal implementation based on oceanbase has existed but the oceanbase cluster is not so easy to build and maintain, I proposal to implement another distributed wal based on kafka.

# Details
## 1. General desgin
### 1.1 Mapping
+ `Shard` (ceresdb) --> `region` (ceresdb):  shardis used to describe a set of tables which will be scheduled by ceresmeta, andregionis used to describe a set of wals which will be written to the same storage unit (for example, a file). Generally, write performance will be not so good If too many storage units are used, so we made such design with reference to Hbase.
+ `Region`(ceresdb) --> `topic` (kafka, with just `wal parition` and `meta partition`) : the amount of partitions on a single node in the kafka cluster can't be too large, otherwise it will have a great impact on latency (the write disk becomes a complete random write). Generally, the number of partitions of 1000 magnitude on a single node is acceptable (Huawei Cloud, Didi, Kafka official website). By mapping like this, we can basically limit the number of partitions on a single node to this range. The kafka topic will be named like this: `namespace_region_x`.
```
+------------------------+         +-----------------------+
|       Namespace        |         |        Kafka          |
|                        |         |                       |
| +--------------------+ |         | +-------------------+ |
| |      Region        | |         | |       Topic       | |
| |+------------------+| |         | |+-----------------+| |
| ||   Region_meta    |-------------->| Meta partition  || |
| |+------------------+| |         | |+-----------------+| |
| |+------------------+| |         | |+-----------------+| |
| ||   Region wal     |-------------->|  Wal partition  || |
| |+------------------+| |         | |+-----------------+| |
| +--------------------+ |         | +-------------------+ |
|                        |         |                       |
| +--------------------+ |         | +-------------------+ |
| |      Region        | |         | |       Topic       | |                                                              
| |       ...          | |         | |        ...        | | 
| +--------------------+ |         | +-------------------+ |                                                              
|         ...            |         |          ...          |
+------------------------+         +-----------------------+
```
### 1.2 Record Format
Meta record, used to mark the latest start sequence number :
```
Key:
+----------------------+---------------+
|  version header(u8)  | table id(u32) |
+----------------------+---------------+

Value:
+--------------------+----------------------------+
| version header(u8) | start sequence number(u64) |
+--------------------+----------------------------+
```
Wal record, `is_start` field is needed because following situation can happen:
<?xml version="1.0" encoding="UTF-8"?>
<!-- Do not edit this file with editors other than diagrams.net -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="302px" height="191px" viewBox="-0.5 -0.5 302 191" content="&lt;mxfile host=&quot;Electron&quot; modified=&quot;2022-10-08T01:26:11.273Z&quot; agent=&quot;5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/19.0.3 Chrome/102.0.5005.63 Electron/19.0.3 Safari/537.36&quot; etag=&quot;qn62Jv_l-LM5S4Aeoyvv&quot; version=&quot;19.0.3&quot; type=&quot;device&quot;&gt;&lt;diagram id=&quot;HWCGK29aWyv6sxHWs_Xw&quot; name=&quot;第 1 页&quot;&gt;7VnbbptAEP0aHl0Bi7HzmBCnfWikSlbV9HEDY9hmzbrrJcb5+s7CcguORSSjIDV+gTmz13Nm9oItEmzzr5LuknsRAbdcO8otcmu5ruPYPj40ciyRpXNVArFkUQnZDbBmL2BqVmjGItgbrISUEFyxXRcMRZpCqDoYlVIcusU2gkcdYEdj6AxDA+uQcugV+8UilZhZzFulvwGLE1VP2HgeafgUS5Glpr9UpFB6trRqxhTdJzQShxZEVhYJpBCqfNvmAXBNa5exuze89ZAlpGpIhYf08Zgsl/eb9O5lFq5+vFwtg5lp5ZnyzFBhBquOFTfF7EA3Ylvk5pAwBesdDbX3gNGAWKK2HC0HXzeM80BwIdEuuEBIpKqCLJdsih/ieyXFE7Q8ZGHbQYCeWNKIQVPLNFRWqPRB/m7M4EEqyN9kxam5xvAFsQUlj1ikqrA08pjI9RbGPjRx4BsoaYVAhVETeXHdciMBvhgV3qGIOyFFrue27dljUe96E6OenKDe58ow1tHA/5uJyjHbF+vZNRZwvF1ekFP5izWr4rMBiV382pAf62fdI06g7LTEJ5CVo8QAsScWA96E0m9k6v2JUT8fI/3K9FkrKnULztD0QlpVV8iuOpWUfXUpZ3GKZogyAOI3WiSGR41r49iyKNLdnIycbmyNsb8t54NUJmOp7H+qfHmVe1vpR6u8GF9l8t+p3FuxP1rlqwltluOeVT13YptldXMeI8MGH0KnkVmvQsQcrceR/aMzzrn49RDJM99jHO8Mmf2sOqHqGxf3iO6TYjzOSGcat5+MjntClhq8vC79u+MtcFAw0ZzpSDI0Bi5xUHFeSUeGraPjJZTfUwiiGNbGFFIlIhYp5asGfcVlU+a7EDvD6R9Q6mhIpZkSXckhZ+pBV/8yN9bvluc2Ny0XxrG1zA1XSU/ivEY4Z5HJEM6RY1Y7PHHFoM4U9E6LLoFTxZ67A7m8hP2L4890g6pkKVXA9UCwI1qMJxQy0mRkeofcUMZRxc8MPXfIrO3LZyiazefvwtf6e4Gs/gE=&lt;/diagram&gt;&lt;/mxfile&gt;" style="background-color: rgb(255, 255, 255);"><defs/><g><rect x="1" y="120" width="60" height="60" fill="none" stroke="#3700cc" stroke-width="2" pointer-events="all"/><rect x="61" y="120" width="60" height="60" fill="none" stroke="#a50040" stroke-width="2" pointer-events="all"/><rect x="121" y="120" width="60" height="60" fill="none" stroke="#3700cc" stroke-width="2" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 58px; height: 1px; padding-top: 150px; margin-left: 122px;"><div data-drawio-colors="color: #ffffff; " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(255, 255, 255); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;"><font color="#000000" style="font-size: 14px;">2</font></div></div></div></foreignObject><text x="151" y="154" fill="#ffffff" font-family="Helvetica" font-size="12px" text-anchor="middle">2</text></switch></g><rect x="181" y="120" width="60" height="60" fill="none" stroke="#3700cc" stroke-width="2" pointer-events="all"/><rect x="1" y="135" width="60" height="30" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 58px; height: 1px; padding-top: 150px; margin-left: 2px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;"><font style="font-size: 14px;">Start 1</font></div></div></div></foreignObject><text x="31" y="154" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">Start 1</text></switch></g><rect x="61" y="135" width="60" height="30" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 58px; height: 1px; padding-top: 150px; margin-left: 62px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;"><font style="font-size: 14px;">Start 1</font></div></div></div></foreignObject><text x="91" y="154" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">Start 1</text></switch></g><rect x="181" y="135" width="60" height="30" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 58px; height: 1px; padding-top: 150px; margin-left: 182px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;"><font style="font-size: 14px;">Start 3</font></div></div></div></foreignObject><text x="211" y="154" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">Start 3</text></switch></g><rect x="241" y="120" width="60" height="60" fill="none" stroke="#a50040" stroke-width="2" pointer-events="all"/><rect x="241" y="135" width="60" height="30" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 58px; height: 1px; padding-top: 150px; margin-left: 242px;"><div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;"><font style="font-size: 14px;">2</font></div></div></div></foreignObject><text x="271" y="154" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">2</text></switch></g><rect x="1" y="70" width="120" height="120" fill="none" stroke="rgb(0, 0, 0)" stroke-width="2" stroke-dasharray="6 6" pointer-events="all"/><rect x="31" y="80" width="60" height="30" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 58px; height: 1px; padding-top: 95px; margin-left: 32px;"><div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 14px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">Delete</div></div></div></foreignObject><text x="61" y="99" fill="#000000" font-family="Helvetica" font-size="14px" text-anchor="middle">Delete</text></switch></g><path d="M 211 40 L 211 113.63" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 211 118.88 L 207.5 111.88 L 211 113.63 L 214.5 111.88 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/><rect x="181" y="10" width="60" height="30" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 58px; height: 1px; padding-top: 25px; margin-left: 182px;"><div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 14px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">Unfortunately meta record put failed</div></div></div></foreignObject><text x="211" y="29" fill="#000000" font-family="Helvetica" font-size="14px" text-anchor="middle">Unfortun...</text></switch></g></g><switch><g requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"/><a transform="translate(0,-5)" xlink:href="https://www.diagrams.net/doc/faq/svg-export-text-problems" target="_blank"><text text-anchor="middle" font-size="10px" x="50%" y="100%">Text is not SVG - cannot display</text></a></switch></svg> 
```
Key:
+-------------------+----------------+----------------------+-------------+
| version header(u8)|  table id(u32) | sequence number(u64) | is start(u8)|
+-------------------+----------------+----------------------+-------------+

Value:
+--------------------+----------+
| version header(u8) | playload |
+--------------------+----------+
```
### 1.3 Data structure
The data structure used to record above information is like this (just use to display, thread safe is not considered yet) : 

```
/// Used to record one table's log state.
struct LogState {
    /// The sequence number of the newest log entry 
    next_sequence_num: SequenceNumber,
    /// The kafka offset in its partition of the newest log entry 
    cur_offset: Option<KafkaOffset>,
    /// The start kafka offset of current log set 
    /// which is still not deleted(due to compaction)
    start_offset: Option<KafkaOffset>,
}

/// All tables in the same shard will be managed by a `Region`.
struct Region {
    ...
    log_states: HashMap<TableId, LogState>,
    ...
}
```
## 2. Main process
### 2.1 Open namespace
- Fetch all topic and filter them according to the namespace prefix.Cache the results after.
### 2.2 Open region
- Search the regionin opened namespace. 
- If not found and auto creating is defined,  create correspoding topic in kafka and add it to cache.
- Return the pointer of `region`.
### 2.3 Write
- Open the corresponding `region` (define auto creating).
- Put the log batch to `wal partition`.
- Update `cur_offset` and `next_sequence_number` in memory.
### 2.4 Read
- Open the corresponding region.
- The actual log's fetching work will be done by a fetcher thread.
- Fetcher thread will be triggered by the first table which reads logs, and all tables will be assigned a channel to wait their logs after.
- The fetcher thread will do two things as follow:
  - Firstly, read all logs from `meta partition` and get their `start_sequence_num`, all logs belongs to a table but with sequence nums smaller than `start_sequence_num` will be filtered. 
  - Fetch logs from `wal partition` from region topic and put them to corresponding channel.
### 2.5 Delete
Log's deletion can be splitted to two steps:
+ Mark the delete offset.
+ Do delayed deletion periodically in a cleaner thread.
#### Mark
+ Each table's `cur_sequence_num` and `cur_offset` will be updated in each logs writing, and `start_offset` will be updated in its first log writing.
+ When `mark_delete_entries_up_to` is called by a table, it will make firstly make `start_offset` None.
+ Put a record with its `table_id` and `next_sequence_num` to corresponding `meta partition` in `region topic`. Error while pushing is tolerable, it will just make the replay time of this table longer.
#### Delete
The deletion logic done in a cleaner task, and it may be a bit complicated. In cleaner's checking, I think logs should be considered to delete in these two situation:
- Common cleaning:
  - Scan all `log_states` in region,  check their `start_offset` and get their maximum `cur_offset`(or directly get it from kafka?) .
  - If all the start_offsets are None, it represents that evey table is just compacted, we will delete records up to maximum `cur_offset`.
  - Otherwise, we will delete records up to the minimum `start_offset`.
- Too large wal size (while some tables have low update frequency or is never updated for a long time) :
  - We should get such tables and flush them, and try to clean the wals after.
  - But the stategy about this still needs more consideration and discussion, the simplest way is to flush all tables in the region.

# Drawbacks
Due to wals of all tables in a region will be written together, the splitting work is needed while replaying, which leads to complicated replaying and possible lower replaying performance.

# Alternatives
Hbase can be a choice, too. But it is a bit complicated to build and maintain because Hbase depends on HDFS.
